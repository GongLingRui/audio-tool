# Read-Rhyme：AI 语音与系统改进建议

> 本文档基于当前项目状态（前端 read-rhyme、后端 backend、参考 alexandria-audiobook）与 2024–2025 年 AI 语音/有声书行业实践，整理 AI 语音能力与整体系统尚需完善的方向，供后续迭代参考。

---

## 一、项目现状简要回顾

| 模块 | 现状
 | 说明 |
|------|------|------|
| **前端** | read-rhyme (React + Vite + Zustand) | Loveable 生成，需继续打磨 |
| **后端** | backend (FastAPI + SQLite) | Python + FFmpeg，TTS 支持外部/Qwen3-TTS |
| **参考项目** | alexandria-audiobook | 脚本生成、分块、导出、LoRA 等可对照迁移 |

**已具备能力**：用户与书籍管理、项目与脚本 API、智能分块、语音配置与情感控制、Qwen3-TTS、RAG、语音克隆/设计/增强、多格式导出等。  
**待完善**（见 PROJECT_SUMMARY）：TTS 实际音频生成闭环、LLM 脚本生成集成、WebSocket 实时进度、播放器与后端音频对接、语音克隆/LoRA 的完整落地等。

下文分「AI 语音」与「系统整体」两部分给出改进建议。

---

## 二、AI 语音相关改进

### 2.1 行业趋势与可对标能力

结合公开资料与最佳实践，以下方向可与现有能力对照，查漏补缺：

| 方向 | 行业常见做法 | 当前项目 | 建议 |
|------|--------------|----------|------|
| **自然度** | 神经声码器（如 HiFi-GAN）、MOS 目标 ≥4.2 | 已有 Qwen3-TTS、外部 TTS | 明确主推引擎（本地/外部），做 A/B 听感评估 |
| **首包/流式** | 首包延迟 &lt;300ms、流式合成 | 批量生成为主 | 对「试听」「单句预览」增加流式或短文本快速路径 |
| **多语言** | 多语言统一表征、语言自动识别 | 多语言支持已有 | 在 UI 和 API 中暴露语言/口音选项，便于有声书多语种 |
| **情感控制** | 情感 3D 建模、细腻过渡 | 已有情感预设与参数 | 见 2.3：增加场景化预设、情感渐变 |
| **长文本** | 分段注意力 + 语义缓存，保持节奏连贯 | 智能分块 + 按块生成 | 分块边界与 TTS 标点/断句对齐，避免截断感 |
| **SSML/控制** | 停顿、重音、语速标签 | 依赖 TTS 引擎能力 | 若引擎支持，在脚本层增加 SSML 或等价控制（如 `<break>`) |
| **成本与规模** | 按字符/按请求计费、私有化部署 | 本地 + 外部可选 | 在配置中区分「本地优先」与「外部降级」策略 |

建议在路线图中明确：**主 TTS 引擎（Qwen3-TTS / 外部）**、**质量目标（如 MOS 或主观评分）**、**延迟与流式**的优先级。

---

### 2.2 多角色一致性与语音克隆

有声书场景下，同一角色在不同章节、不同情感下声音需保持稳定。

- **说话人标签与映射**  
  - 脚本中已有 `speaker` 等字段，需与「角色 → 语音配置」强绑定。  
  - 建议：角色名规范化（别名映射）、默认旁白/叙述者统一用一个配置，避免同一角色多套 voice_id。

- **克隆样本量与质量**  
  - 行业常见：3–5 分钟清晰、多语速多情感的录音；高质量克隆可到 5–10 个样本、每段 5–15 秒。  
  - 建议：  
    - 在上传与「语音克隆」流程中提示：推荐时长、样本数、无背景音乐、设备一致。  
    - 可选：对上传参考音频做简单质量检查（响度、静音比例、长度），不合格时提示用户。

- **副语言与标签**  
  - 部分方案支持在文本中插入 `<laugh>`、`<sigh>` 等，增强对话感。  
  - 若 TTS 引擎支持，可在脚本生成或后处理阶段加入此类标签，并在 UI 上提供「插入笑声/叹息」等快捷操作。

- **长文本分段一致性**  
  - 采用「分段 + 语义/状态缓存」可减少前后段语气断裂。  
  - 当前按 chunk 生成时，可在每个 chunk 的 TTS 调用中传入「上一句结尾特征」或「角色状态」（若引擎支持），减少同一角色在不同块之间的音色漂移。

可参考 alexandria-audiobook 的 voice_config 与分块逻辑，在 backend 中固化「角色 ↔ voice_config ↔ 可选 ref_audio_path / voice_id」的映射与校验。

---

### 2.3 情感与风格控制

现有情感预设与参数已较完整，可从「易用性」和「有声书场景」再加强：

- **场景化预设**  
  - 除通用 happy/sad/angry 等，增加「有声书专用」预设：如「叙述者-平静」「叙述者-紧张」「对话-争吵」「对话-亲密」「旁白-悬疑」等，并写清使用说明与示例句。

- **情感渐变**  
  - 文档中已有「情感曲线」示例，可在前端提供简单配置：按章节或按段落设置「起始情感 → 结束情感」，后端按块或按句插值 emotion 参数，使长段落情绪过渡更自然。

- **与 VOICE_REFERENCE 结合**  
  - 将 VOICE_REFERENCE 中的 timbre/delivery/emotion 词汇暴露到「语音设计」或「情感高级」面板（下拉或搜索），便于高级用户精细控制，同时保持与 Qwen3-TTS VoiceDesign 的 description/instruct 一致。

- **稳定性与表现力平衡**  
  - 类似 ElevenLabs 的 stability 概念：高稳定性适合旁白，低稳定性适合强烈情绪。若引擎支持，可在 API 和 UI 增加「稳定性/表现力」滑块，并给出推荐区间。

---

### 2.4 录音与训练数据质量（克隆/LoRA）

若后续强化「用户自带录音」的克隆或 LoRA 训练，建议在流程中体现以下最佳实践：

- **录音规范**  
  - 环境安静、信噪比建议 &gt;20dB；峰值约 -3～-6 dB，避免削波。  
  - 设备一致：同一麦克风、距离、采样率（如 44.1kHz/16bit）。  
  - 使用 pop filter、尽量平坦 EQ、避免前期过度压缩，保留自然动态。

- **训练集内容**  
  - 涵盖不同语速、情感、句长；包含自然停顿（如句间 1–1.5 秒）。  
  - 清洗：去除重复、口误、过多 filler 词；响度归一化（如 -3 dBFS），便于模型学习。

- **伦理与合规**  
  - 克隆/训练前明确「知情同意」与用途说明。  
  - 可选：对生成音频做数字水印或来源标识，便于追溯与滥用防控。

可在「语音克隆上传」和「LoRA 训练」页面增加「录音建议」与「同意条款」勾选，并在后端记录同意记录。

---

### 2.5 长文本与性能

- **分块与 TTS 断句对齐**  
  - 分块时尽量在句号、问号、感叹号等处切分，避免在词中或短语中间切断，减少 TTS 歧义与不自然停顿。  
  - 若使用 NLP 分句（如 BERT 分句），可与现有 chunk_service 结合，先按句再按「同一说话人 + 长度上限」合并。

- **延迟与 RTF**  
  - 行业常见目标：首包 &lt;300ms，RTF &lt;0.5。  
  - 对「整书生成」保持当前批量 + 队列即可；对「单句试听」「段落预览」可单独走快速路径（短文本、高优先级、可选流式）。

- **缓存**  
  - 相同 (text, speaker, voice_config, emotion) 的片段可缓存音频或 mel，避免重复调用 TTS。  
  - 缓存策略需考虑磁盘与 invalidation（如 voice_config 变更时清空相关缓存）。

---

### 2.6 语音增强与导出

- **响度与标准化**  
  - 有声书常采用 -16～-18 LUFS；当前已有 enhance_speech、target_lufs 等，建议将「导出前 LUFS 归一化」设为默认或推荐选项，并在 UI 标注「适合有声书/播客」。

- **多格式与兼容性**  
  - 已支持 combined / audacity / voicelines 等，可再确认：  
    - 各格式的元数据（标题、章节、作者）；  
    - 常见播放器与平台的兼容性（如 iTunes、Audible 规范若有要求）。

- **淡入淡出与段落间静音**  
  - 已有「自然停顿」设计，可统一文档化：不同说话人间 500ms、同说话人 250ms 等，并在导出管线中固化，避免手工后处理。

---

### 2.7 LoRA 与定制化

- PROJECT_SUMMARY 中「LoRA 训练功能」仍为待完善。  
- alexandria-audiobook 的 `train_lora.py` 等可作为参考，建议：  
  - 在 backend 提供「准备训练数据 → 启动训练 → 查询状态」的 API；  
  - 训练完成后，将 LoRA 权重与 project/voice_config 关联，在 TTS 调用时传入 lora_model_path；  
  - 前端可增加「高级 → LoRA 训练」入口，用于愿意自训练的进阶用户。

---

## 三、系统整体改进

### 3.1 WebSocket 实时进度

- **现状**：文档（如 05-frontend-backend-integration）中规划了 WebSocket，但 backend 中未发现 WebSocket 实现；进度依赖轮询 `GET /projects/{id}/chunks/progress`。  
- **建议**：  
  - 在 backend 增加 WebSocket 端点（如 `/ws/projects/{project_id}/progress`），在 chunk 批量生成时推送：当前完成数、总数、当前 chunk_id、错误信息等。  
  - 前端在「生成音频」页建立 WebSocket 连接，收到消息后更新 progress 与日志，减少轮询并提升体验。  
  - 需考虑断线重连、鉴权（仅项目所属用户可订阅）。

---

### 3.2 播放器与后端音频对接

- **现状**：  
  - `AudioPlayer` 使用「模拟播放」与本地生成的波形，未从后端拉取真实音频 URL。  
  - `audioStore` 的 `duration` 为 mock（如 590s），`paragraphTimeMap` 由 `generateMockTimeMap` 生成。  
- **建议**：  
  - 项目进入「已生成/已合并」状态后，前端从 `GET /api/projects/{id}/audio` 或导出接口获取最终音频 URL（或临时 signed URL）。  
  - 播放器加载该 URL（如通过 wavesurfer 的 `load(url)`），用真实 duration 更新 store。  
  - **段落 ↔ 时间轴**：使用后端在分块/合并时计算的 `chunk` 的 start/end 时间，或合并后的段落级时间戳，生成 `paragraphTimeMap`，替换 mock，实现「点击段落跳转播放」与「播放高亮当前段」。

---

### 3.3 书籍 → 项目 → 脚本 → 分块 → 生成 → 导出 → 播放 全流程

- **目标**：从前台上传书籍到最终在同一个前端页面听有声书，一条链打通。  
- **建议**：  
  - 明确各步骤的入口与状态：书籍已解析 → 项目已创建 → 脚本已生成/已审查 → 分块已创建 → 音频已生成/部分失败 → 已合并 → 已导出。  
  - 前端根据 project 状态显示「下一步」按钮与简短说明（如「请先生成脚本」「正在生成音频，可通过进度查看」）。  
  - 对「脚本审查」「分块预览」「单 chunk 重试」等，在 UI 上提供明确入口，避免用户不知道如何修正错误。

---

### 3.4 LLM 脚本生成集成

- **现状**：脚本生成 API 已有，但 PROJECT_SUMMARY 将「LLM 脚本生成集成」列为待完善，可能指：默认使用本地/配置的 LLM、提示词管理、错误处理与重试。  
- **建议**：  
  - 在 backend 配置中明确 `LLM_BASE_URL` 及模型名，脚本生成服务统一通过该配置调用 LLM。  
  - 使用 default_prompts.txt 等作为系统提示词，并在 API 或管理界面支持「项目级提示词覆盖」。  
  - 对 LLM 超时、JSON 解析失败、内容过短/过长等情况，返回明确错误码与提示，前端提示用户重试或修改书籍/参数。

---

### 3.5 错误处理与重试

- **TTS 失败**：单 chunk 失败时，当前会得到 failed 状态；建议支持「仅重试失败 chunk」的接口，并在前端提供「重试失败项」按钮。  
- **网络/超时**：对长时间运行的生成任务，考虑幂等性与断点续传（如记录已完成的 chunk_id，下次只生成未完成）。  
- **用户可见信息**：将后端错误码映射为简短中文提示（如「语音服务暂时不可用，请稍后重试」「该角色语音配置缺失」），避免直接暴露堆栈。

---

### 3.6 安全与权限

- **音频与静态文件**：若音频通过 `/static/` 或类似路径访问，需校验当前用户是否有权访问对应 project 的音频，避免未授权下载。  
- **项目与书籍归属**：所有 project/book 相关 API 应校验归属，避免越权访问。  
- **敏感配置**：API Key、LLM URL、TTS URL 等仅保存在服务端环境变量或密钥管理，不在前端或日志中暴露。

---

### 3.7 测试与可观测性

- **测试**：  
  - 关键路径：书籍上传 → 项目创建 → 脚本生成 → 分块 → 生成 1～2 个 chunk → 合并/导出。  
  - 覆盖：权限校验、无效 project_id、TTS 超时模拟等。  
- **日志与监控**：  
  - 对 TTS 调用耗时、失败率、各 project 的 chunk 完成情况做简单统计或日志，便于排查「生成慢」或「失败集中在某类文本/某引擎」的问题。

---

### 3.8 前端体验与性能

- **大列表**：书籍列表、项目列表、chunk 列表在数据量大时使用分页或虚拟滚动，避免一次性渲染过多 DOM。  
- **生成中状态**：生成音频时，除进度外，可提供「预计剩余时间」（基于已完成的平均每 chunk 耗时）或至少「正在生成…」的明确提示。  
- **响应式与无障碍**：确保播放器、表单在移动端可用；关键按钮具备可访问性标签。

---

## 四、优先级建议（参考）

| 优先级 | 方向 | 说明 |
|--------|------|------|
| P0 | 播放器与后端音频 + 段落时间轴对接 | 用户能真正「听到」自己生成的有声书，闭环体验 |
| P0 | 全流程状态与引导 | 从上传到播放的步骤清晰、可操作 |
| P1 | WebSocket 实时进度 | 长书生成时体验明显提升 |
| P1 | TTS 失败重试与错误提示 | 提高成功率与可排查性 |
| P1 | 角色与语音配置一致性 | 多角色有声书质量基础 |
| P2 | 情感场景化预设与渐变 | 提升表现力与易用性 |
| P2 | 语音克隆上传指引与质量提示 | 提高克隆可用率 |
| P2 | 缓存与首包/流式预览 | 性能与试听体验 |
| P3 | LoRA 训练 API 与前端入口 | 满足进阶定制需求 |
| P3 | 伦理与合规（同意、水印） | 若面向生产与对外服务 |

---

## 五、参考资源

- 项目内：`PROJECT_SUMMARY.md`、`docs/AI_VOICE_QUICKSTART.md`、`docs/04-audio-processing.md`、`alexandria-audiobook/VOICE_REFERENCE.md`  
- 外部：ElevenLabs 文档（情感与稳定性）、百度云/阿里云 TTS 选型与最佳实践、Coqui TTS / GLM-TTS 等开源方案的多说话人与长文本处理。

---

*文档版本：初稿 | 基于 2025年2 月项目状态与公开资料整理*
