# 有声书生成项目 - 概述与架构设计

## 1. 项目概述

### 1.1 项目名称
**Read-Rhyme** - AI 驱动的有声书生成与阅读平台

### 1.2 项目目标
构建一个端到端的有声书生成和管理系统，用户可以上传文本内容，系统自动生成高质量的多角色有声书，并提供阅读、笔记、音频播放等功能。

### 1.3 核心功能
1. **文本上传与解析**：支持 TXT、PDF、EPUB 等格式的文本上传
2. **智能脚本生成**：使用 LLM 自动解析文本，标注角色和对话
3. **多角色 TTS 生成**：支持多种语音类型（预设、克隆、LoRA 训练、语音设计）
4. **音频编辑与合并**：智能停顿插入、音频合并
5. **阅读器界面**：同步文本显示与音频播放
6. **笔记系统**：文本高亮、笔记添加、管理
7. **书架管理**：书籍分类、进度追踪

### 1.4 技术栈

#### 后端技术栈
| 组件 | 技术选型 | 说明 |
|------|---------|------|
| Web 框架 | FastAPI | 高性能异步 API 框架 |
| TTS 引擎 | Qwen3-TTS / Edge-TTS | 文本转语音引擎 |
| 音频处理 | FFmpeg, pydub, librosa | 音频处理和编辑 |
| LLM 集成 | OpenAI 兼容 API | 脚本生成和审查 |
| 数据库 | SQLite + SQLAlchemy | 轻量级关系数据库 |
| ORM | SQLAlchemy | 数据库 ORM 框架 |
| 文件存储 | 本地文件系统 | 音频和静态资源存储 |
| 异步任务 | asyncio, BackgroundTasks | 异步任务处理 |

#### 前端技术栈
| 组件 | 技术选型 | 说明 |
|------|---------|------|
| 框架 | React 18 + TypeScript | 现代化前端框架 |
| 构建工具 | Vite | 快速构建工具 |
| 路由 | React Router DOM | 单页应用路由 |
| 状态管理 | Zustand | 轻量级状态管理 |
| 数据请求 | TanStack Query | 数据获取和缓存 |
| UI 组件 | shadcn/ui + Radix UI | 现代化组件库 |
| 样式 | Tailwind CSS | 实用优先的 CSS 框架 |
| 音频可视化 | WaveSurfer.js | 音频波形显示 |

## 2. 系统架构设计

### 2.1 整体架构图

```
┌─────────────────────────────────────────────────────────────────────┐
│                           Read-Rhyme System                          │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐   │
│  │                        Frontend (React)                       │   │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────────┐  │   │
│  │  │  书架页  │  │  阅读器  │  │ 编辑器   │  │  设置页面    │  │   │
│  │  └──────────┘  └──────────┘  └──────────┘  └──────────────┘  │   │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────────┐  │   │
│  │  │ 笔记系统 │  │ 音频播放 │  │ 上传模块 │  │ 语音配置     │  │   │
│  │  └──────────┘  └──────────┘  └──────────┘  └──────────────┘  │   │
│  └──────────────────────────────────────────────────────────────┘   │
│                                 │                                    │
│                                 │ HTTP/REST API                      │
│                                 ▼                                    │
│  ┌──────────────────────────────────────────────────────────────┐   │
│  │                       Backend (FastAPI)                       │   │
│  │                                                              │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────────┐   │   │
│  │  │  脚本生成    │  │  TTS 引擎    │  │   音频处理       │   │   │
│  │  │  Module      │  │  Engine      │  │   Processor      │   │   │
│  │  └──────────────┘  └──────────────┘  └──────────────────┘   │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────────┐   │   │
│  │  │  项目管理    │  │  语音管理    │  │   任务调度       │   │   │
│  │  │  Project     │  │  Voice       │  │   Scheduler      │   │   │
│  │  └──────────────┘  └──────────────┘  └──────────────────┘   │   │
│  └──────────────────────────────────────────────────────────────┘   │
│                                 │                                    │
│                                 ▼                                    │
│  ┌──────────────────────────────────────────────────────────────┐   │
│  │                      External Services                         │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────────┐   │   │
│  │  │  LLM API     │  │  TTS 服务    │  │   FFmpeg         │   │   │
│  │  │  (OpenAI)    │  │  (Qwen/Edge) │  │   (本地)         │   │   │
│  │  └──────────────┘  └──────────────┘  └──────────────────┘   │   │
│  └──────────────────────────────────────────────────────────────┘   │
│                                 │                                    │
│                                 ▼                                    │
│  ┌──────────────────────────────────────────────────────────────┐   │
│  │                      Storage Layer                            │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────────┐   │   │
│  │  │  SQLite DB   │  │  文件存储    │  │   配置文件       │   │   │
│  │  └──────────────┘  └──────────────┘  └──────────────────┘   │   │
│  └──────────────────────────────────────────────────────────────┘   │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 2.2 模块划分

#### 2.2.1 后端模块

```
backend/
├── app/
│   ├── __init__.py
│   ├── main.py                 # FastAPI 应用入口
│   ├── config.py               # 配置管理
│   ├── database.py             # 数据库连接
│   ├── models/                 # 数据模型
│   │   ├── __init__.py
│   │   ├── book.py             # 书籍模型
│   │   ├── user.py             # 用户模型
│   │   ├── project.py          # 项目模型
│   │   ├── script.py           # 脚本模型
│   │   ├── chunk.py            # 音频块模型
│   │   ├── voice.py            # 语音配置模型
│   │   └── highlight.py        # 高亮笔记模型
│   ├── schemas/                # Pydantic 模式
│   │   ├── __init__.py
│   │   ├── book.py
│   │   ├── user.py
│   │   ├── project.py
│   │   ├── script.py
│   │   └── audio.py
│   ├── api/                    # API 路由
│   │   ├── __init__.py
│   │   ├── books.py            # 书籍管理 API
│   │   ├── projects.py         # 项目管理 API
│   │   ├── scripts.py          # 脚本生成 API
│   │   ├── audio.py            # 音频生成 API
│   │   ├── voices.py           # 语音管理 API
│   │   └── highlights.py       # 笔记管理 API
│   ├── services/               # 业务逻辑服务
│   │   ├── __init__.py
│   │   ├── script_generator.py # 脚本生成服务
│   │   ├── tts_engine.py       # TTS 引擎服务
│   │   ├── audio_processor.py  # 音频处理服务
│   │   ├── voice_manager.py    # 语音管理服务
│   │   └── file_handler.py     # 文件处理服务
│   ├── core/                   # 核心功能
│   │   ├── __init__.py
│   │   ├── security.py         # 安全相关
│   │   ├── deps.py             # 依赖注入
│   │   └── exceptions.py       # 自定义异常
│   ├── utils/                  # 工具函数
│   │   ├── __init__.py
│   │   ├── audio_utils.py      # 音频工具
│   │   ├── text_utils.py       # 文本工具
│   │   └── llm_utils.py        # LLM 工具
│   └── static/                 # 静态文件
│       ├── uploads/            # 上传文件
│       ├── audio/              # 音频文件
│       └── exports/            # 导出文件
├── tests/                      # 测试
├── requirements.txt            # Python 依赖
├── pyproject.toml             # 项目配置
└── .env.example               # 环境变量示例
```

#### 2.2.2 前端模块

```
read-rhyme/
├── src/
│   ├── pages/                  # 页面组件
│   │   ├── Index.tsx           # 书架首页
│   │   ├── Reader.tsx          # 阅读器页面
│   │   ├── Editor.tsx          # 编辑器页面（新增）
│   │   └── Settings.tsx        # 设置页面（新增）
│   ├── components/             # 组件
│   │   ├── book/               # 书籍相关组件
│   │   │   ├── BookCard.tsx
│   │   │   ├── BookGrid.tsx
│   │   │   └── UploadModal.tsx
│   │   ├── reader/             # 阅读器组件
│   │   │   ├── ReaderContent.tsx
│   │   │   ├── TableOfContents.tsx
│   │   │   └── HighlightMenu.tsx
│   │   ├── audio/              # 音频组件
│   │   │   ├── AudioPlayer.tsx
│   │   │   └── Waveform.tsx
│   │   ├── notes/              # 笔记组件
│   │   │   ├── NoteSidebar.tsx
│   │   │   ├── NoteInput.tsx
│   │   │   └── NoteList.tsx
│   │   └── editor/             # 编辑器组件（新增）
│   │       ├── ScriptEditor.tsx
│   │       ├── VoiceConfig.tsx
│   │       └── ChunkTable.tsx
│   ├── stores/                 # 状态管理
│   │   ├── bookStore.ts
│   │   ├── highlightStore.ts
│   │   ├── audioStore.ts
│   │   └── projectStore.ts     # 新增
│   ├── services/               # API 服务
│   │   ├── api.ts              # API 客户端
│   │   ├── books.ts            # 书籍 API
│   │   ├── projects.ts         # 项目 API
│   │   ├── scripts.ts          # 脚本 API
│   │   ├── audio.ts            # 音频 API
│   │   └── highlights.ts       # 笔记 API
│   ├── types/                  # TypeScript 类型
│   │   ├── book.ts
│   │   ├── project.ts
│   │   ├── script.ts
│   │   └── audio.ts
│   ├── hooks/                  # 自定义 Hooks
│   │   ├── useAudioPlayer.ts
│   │   ├── useHighlights.ts
│   │   └── useProject.ts       # 新增
│   └── utils/                  # 工具函数
│       ├── audio.ts
│       └── text.ts
├── public/                     # 静态资源
├── package.json
├── vite.config.ts
└── tsconfig.json
```

### 2.3 数据流设计

#### 2.3.1 书籍上传流程

```
┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐
│  用户   │───▶│  前端   │───▶│  后端   │───▶│  存储   │
└─────────┘    └─────────┘    └─────────┘    └─────────┘
                    │              │
                    ▼              ▼
               ┌─────────┐    ┌─────────┐
               │ 显示    │    │ 文件    │
               │ 进度    │    │ 解析    │
               └─────────┘    └─────────┘
```

#### 2.3.2 音频生成流程

```
┌───────────┐     ┌───────────┐     ┌───────────┐
│ 上传文本   │ ──▶│ 脚本生成   │ ──▶│ 语音配置   │
└───────────┘     └───────────┘     └───────────┘
                      │                   │
                      ▼                   ▼
                 ┌───────────┐     ┌───────────┐
                 │ LLM 解析   │     │ 选择语音   │
                 │ 标注角色   │     │ 克隆/预设  │
                 └───────────┘     └───────────┘
                          \           /
                           \         /
                            ▼       ▼
                      ┌─────────────┐
                      │  分块处理    │
                      │  500字符/块 │
                      └─────────────┘
                            │
                            ▼
                      ┌─────────────┐
                      │  TTS 生成   │
                      │  并行处理    │
                      └─────────────┘
                            │
                            ▼
                      ┌─────────────┐
                      │  音频合并    │
                      │  智能停顿   │
                      └─────────────┘
                            │
                            ▼
                      ┌─────────────┐
                      │  导出音频    │
                      │  MP3/WAV    │
                      └─────────────┘
```

#### 2.3.3 阅读器同步流程

```
┌───────────┐     ┌───────────┐     ┌───────────┐
│ 音频播放   │ ──▶│ 时间更新   │ ──▶│ 段落映射   │
└───────────┘     └───────────┘     └───────────┘
                                           │
                                           ▼
                                    ┌───────────┐
                                    │ 滚动定位   │
                                    │ 高亮当前   │
                                    └───────────┘
```

## 3. 技术决策说明

### 3.1 后端技术选型

| 技术 | 选择理由 |
|------|---------|
| **FastAPI** | 高性能异步框架，自动生成 API 文档，类型验证 |
| **SQLite** | 轻量级，无需额外服务，适合中小规模应用 |
| **SQLAlchemy** | 成熟的 ORM，支持异步操作 |
| **Qwen3-TTS** | 开源高质量中文 TTS，支持语音克隆和 LoRA 训练 |
| **FFmpeg** | 业界标准音频处理工具，功能强大 |
| **pydub** | 简单易用的音频处理库，基于 FFmpeg |

### 3.2 前端技术选型

| 技术 | 选择理由 |
|------|---------|
| **React 18** | 成熟的前端框架，生态丰富 |
| **TypeScript** | 类型安全，提高代码质量 |
| **Vite** | 快速开发服务器，HMR 体验好 |
| **Zustand** | 轻量级状态管理，学习曲线平缓 |
| **shadcn/ui** | 现代化组件库，基于 Radix UI，可定制性强 |
| **WaveSurfer.js** | 专业音频波形可视化 |

### 3.3 存储设计

| 数据类型 | 存储方案 | 理由 |
|---------|---------|------|
| 结构化数据 | SQLite | 关系型数据，事务支持 |
| 音频文件 | 本地文件系统 | 大文件存储，直接访问 |
| 配置数据 | JSON 文件 | 便于编辑和版本控制 |

## 4. 部署架构

### 4.1 开发环境

```
┌─────────────────────────────────────────┐
│           开发机 (localhost)             │
├─────────────────────────────────────────┤
│  前端: Vite Dev Server (http://localhost:5173)  │
│  后端: Uvicorn (http://localhost:8000)   │
│  数据库: SQLite (./backend/data/app.db)  │
│  静态文件: ./backend/app/static/         │
└─────────────────────────────────────────┘
```

### 4.2 生产环境

```
┌─────────────────────────────────────────┐
│              服务器                      │
├─────────────────────────────────────────┤
│  Nginx (反向代理 + 静态文件)             │
│    │                                     │
│    ├─▶ /api/* ──▶ FastAPI (Docker)      │
│    └─▶ /* ────▶ React Build (静态)      │
│                                         │
│  Docker Compose:                        │
│    - backend: FastAPI + SQLite           │
│    - frontend: Nginx + React Build       │
└─────────────────────────────────────────┘
```

## 5. 开发计划

### Phase 1: 基础设施搭建
- [ ] 后端项目初始化
- [ ] 数据库模型创建
- [ ] 基础 API 框架搭建
- [ ] 前端 API 服务层

### Phase 2: 核心功能实现
- [ ] 书籍上传和解析
- [ ] 脚本生成服务
- [ ] TTS 引擎集成
- [ ] 音频处理服务

### Phase 3: 前端功能完善
- [ ] 编辑器页面
- [ ] 语音配置界面
- [ ] 进度显示优化

### Phase 4: 高级功能
- [ ] 语音克隆
- [ ] LoRA 训练
- [ ] 批量处理优化

### Phase 5: 测试和优化
- [ ] 单元测试
- [ ] 集成测试
- [ ] 性能优化
